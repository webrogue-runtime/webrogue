name: Webrogue CI

on:
  push:

jobs:
  linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Submodules
      run: |
        git submodule update --init --single-branch --depth=1 external/wasmtime external/gfxstream external/zstd-rs
        git -C external/zstd-rs/ submodule update --init zstd-safe/zstd-sys/zstd

    - name: Cargo test
      run: |
        cargo test --workspace \
          --exclude webrogue-hub-client-openapi \
          --exclude webrogue-launcher-dev \
          --exclude webrogue-launcher \
          --exclude webrogue-android-launcher \
          --exclude webrogue-wrapp-reader

  windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Submodules
      run: |
        git submodule update --init --single-branch --depth=1 external/wasmtime external/gfxstream external/zstd-rs
        git -C external/zstd-rs/ submodule update --init zstd-safe/zstd-sys/zstd

    - name: Cargo test
      run: |
        cargo test --workspace \
          --exclude webrogue-hub-client-openapi \
          --exclude webrogue-launcher-dev \
          --exclude webrogue-launcher \
          --exclude webrogue-android-launcher \
          --exclude webrogue-wrapp-reader

  macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Submodules
      run: |
        git submodule update --init --single-branch --depth=1 external/wasmtime external/gfxstream external/zstd-rs
        git -C external/zstd-rs/ submodule update --init zstd-safe/zstd-sys/zstd

    - name: Cargo test
      run: |
        cargo test --workspace \
          --exclude webrogue-hub-client-openapi \
          --exclude webrogue-launcher-dev \
          --exclude webrogue-launcher \
          --exclude webrogue-android-launcher \
          --exclude webrogue-wrapp-reader
