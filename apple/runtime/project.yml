name: webrogue
configs:
  Debug: debug
  Release: release
  ReleaseLocal: release
projectReferences:
  SDL:
    path: ./external/SDL3/Xcode/SDL/SDL.xcodeproj
settings:
  base:
    MACOSX_DEPLOYMENT_TARGET: 12.0
    IPHONEOS_DEPLOYMENT_TARGET: 15.0
    GENERATE_INFOPLIST_FILE: true
    MARKETING_VERSION: 0.1
    CURRENT_PROJECT_VERSION: 1
    DEAD_CODE_STRIPPING: true
    ENABLE_USER_SCRIPT_SANDBOXING: true
    ENABLE_MODULE_VERIFIER: true
    MODULE_VERIFIER_SUPPORTED_LANGUAGE_STANDARDS: "gnu11 gnu++14"
    ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS: true
  configs:
    Debug:
      CODE_SIGN_IDENTITY: "-"
      CARGO_PROFILE: debug
      CODE_SIGN_STYLE: Manual
    Release:
      CODE_SIGN_IDENTITY: "Apple Development"
      CARGO_PROFILE: aot
      CODE_SIGN_STYLE: Automatic
      DEVELOPMENT_TEAM: LC5F8UX2W7
    ReleaseLocal:
      CODE_SIGN_IDENTITY: "-"
      CARGO_PROFILE: aot
      CODE_SIGN_STYLE: Manual
options:
  createIntermediateGroups: true
targets:
  GFXStream:
    type: library.static
    platform: [macOS, iOS]
    sources:
    - ../../crates/gfxstream/webrogue_gfxstream.cpp
    - ../../external/gfxstream/host/vulkan/VkDecoder.cpp
    - ../../external/gfxstream/host/vulkan/VulkanStream.cpp
    - ../../external/gfxstream/host/vulkan/VulkanHandleMapping.cpp
    - ../../external/gfxstream/host/vulkan/VulkanBoxedHandles.cpp
    - ../../external/gfxstream/host/vulkan/VkDecoderGlobalState.cpp
    - ../../external/gfxstream/host/vulkan/RenderThreadInfoVk.cpp
    - ../../external/gfxstream/host/vulkan/DebugUtilsHelper.cpp
    - ../../external/gfxstream/host/vulkan/DeviceOpTracker.cpp
    - ../../external/gfxstream/host/vulkan/VkCommonOperations.cpp
    - ../../external/gfxstream/host/vulkan/DeviceLostHelper.cpp
    - ../../external/gfxstream/host/vulkan/VkEmulatedPhysicalDeviceQueue.cpp
    - ../../external/gfxstream/host/vulkan/VkEmulatedPhysicalDeviceMemory.cpp
    - ../../external/gfxstream/host/vulkan/VkDecoderSnapshot.cpp
    - ../../external/gfxstream/host/vulkan/VkReconstruction.cpp
    - ../../external/gfxstream/host/vulkan/SwapChainStateVk.cpp
    - ../../external/gfxstream/host/vulkan/DependencyGraph.cpp
    - ../../external/gfxstream/host/vulkan/VkUtils.cpp
    - ../../external/gfxstream/host/vulkan/cereal/common/goldfish_vk_dispatch.cpp
    - ../../external/gfxstream/host/vulkan/cereal/common/goldfish_vk_transform.cpp
    - ../../external/gfxstream/host/vulkan/cereal/common/goldfish_vk_extension_structs.cpp
    - ../../external/gfxstream/host/vulkan/cereal/common/goldfish_vk_reserved_marshaling.cpp
    - ../../external/gfxstream/host/vulkan/cereal/common/goldfish_vk_deepcopy.cpp
    - ../../external/gfxstream/host/vulkan/cereal/common/goldfish_vk_marshaling.cpp
    - ../../external/gfxstream/host/vulkan/emulated_textures/GpuDecompressionPipeline.cpp
    - ../../external/gfxstream/host/vulkan/emulated_textures/AstcTexture.cpp
    - ../../external/gfxstream/host/vulkan/emulated_textures/CompressedImageInfo.cpp
    - ../../external/gfxstream/host/compressed_textures/AstcCpuDecompressorNoOp.cpp
    - ../../external/gfxstream/host/features/Features.cpp
    - ../../external/gfxstream/host/backend/external_object_manager.cpp
    - ../../external/gfxstream/host/backend/vm_operations.cpp
    - ../../external/gfxstream/host/backend/graphics_driver_lock.cpp
    - ../../external/gfxstream/host/health/HealthMonitor.cpp
    - ../../external/gfxstream/host/metrics/Metrics.cpp
    - ../../external/gfxstream/common/base/UdmabufCreator_stub.cpp
    - ../../external/gfxstream/common/base/System.cpp
    - ../../external/gfxstream/common/logging/logging.cpp
    - ../../external/gfxstream/common/base/Thread_pthread.cpp
    - ../../external/gfxstream/host/backend/stream_utils.cpp
    - ../../external/gfxstream/common/base/system-native-mac.mm
    - ../../external/gfxstream/host/health/TestClock.cpp
    settings:
      base:
        HEADER_SEARCH_PATHS:
        - "$(SRCROOT)/../../external/gfxstream/host"
        - "$(SRCROOT)/../../external/gfxstream/host/vulkan"
        - "$(SRCROOT)/../../external/gfxstream/host/vulkan/cereal"
        - "$(SRCROOT)/../../external/gfxstream/host/vulkan/cereal/common"
        - "$(SRCROOT)/../../external/gfxstream/host/features/include"
        - "$(SRCROOT)/../../external/gfxstream/host/gl/gl-host-common/include"
        - "$(SRCROOT)/../../external/gfxstream/host/features/include/gfxstream/host"
        - "$(SRCROOT)/../../external/gfxstream/host/tracing/include"
        - "$(SRCROOT)/../../external/gfxstream/host/backend/include"
        - "$(SRCROOT)/../../external/gfxstream/common/vulkan/include"
        - "$(SRCROOT)/../../external/gfxstream/common/utils/include"
        - "$(SRCROOT)/../../external/gfxstream/include"
        - "$(SRCROOT)/../../external/gfxstream/utils/include"
        - "$(SRCROOT)/../../external/gfxstream/third-party/renderdoc/include"
        - "$(SRCROOT)/../../external/gfxstream/third-party/glm/include"
        - "$(SRCROOT)/../../external/gfxstream/host/compressed_textures/include"
        - "$(SRCROOT)/../../external/gfxstream/host/health/include"
        - "$(SRCROOT)/../../external/gfxstream/common/base/include"
        - "$(SRCROOT)/../../external/gfxstream/host/metrics/include"
        - "$(SRCROOT)/../../external/gfxstream/common/logging/include"
        - "$(SRCROOT)/../../external/gfxstream/host/decoder_common/include"
        - "$(SRCROOT)/../../external/gfxstream/third_party/vulkan/include"
        - "$(SRCROOT)/../../external/gfxstream/host/include"
        - "$(SRCROOT)/../../external/gfxstream/host/iostream/include"
        - "$(SRCROOT)/../../external/gfxstream/third_party/glm/include"
        - "$(SRCROOT)/../../external/gfxstream/third_party/glm/include"
        - "$(SRCROOT)/../../external/gfxstream/host/renderdoc/include"
        - "$(SRCROOT)/../../external/gfxstream/third_party/renderdoc/include"
        - "$(SRCROOT)/../../external/gfxstream/host/library/include"
        - "$(SRCROOT)/../../external/gfxstream/host/snapshot/include"
        - "$(SRCROOT)/../../external/gfxstream/third_party/astc-encoder/Source"
        - "$(SRCROOT)/../../external/gfxstream/third_party/opengl/include"
        CLANG_CXX_LANGUAGE_STANDARD:
        - "gnu++20"
        GCC_PREPROCESSOR_DEFINITIONS:
        - "VK_GFXSTREAM_STRUCTURE_TYPE_EXT=1"
        - "VK_USE_PLATFORM_METAL_EXT=1"
        - "VK_USE_PLATFORM_MACOS_MVK=1"
        OTHER_CPLUSPLUSFLAGS:
        - "$(OTHER_CFLAGS)"
        - "-Wno-return-type-c-linkage"
  Launcher:
    type: application
    platform: macOS
    sources:
    - macos/launcher
    - common
    settings:
      base:
        CODE_SIGN_ENTITLEMENTS: macos/launcher/launcher.entitlements
        INFOPLIST_FILE: macos/launcher/Info.plist
        PRODUCT_BUNDLE_IDENTIFIER: io.github.webrogue-runtime.WebrogueLauncher
        PRODUCT_NAME: Webrogue launcher
        ENABLE_HARDENED_RUNTIME: true
        INFOPLIST_KEY_LSApplicationCategoryType: public.app-category.utilities
        ENABLE_PREVIEWS: true
    dependencies:
    - target: Runtime
      embed: true
      codeSign: true
      copy:
        destination: executables
    - bundle: libMoltenVK.dylib
      embed: true
      codeSign: true
    preBuildScripts:
      - script: "cp \"${SRCROOT}/external/MoltenVK/MoltenVK/dynamic/dylib/macOS/libMoltenVK.dylib\" \"${BUILT_PRODUCTS_DIR}/libMoltenVK.dylib\""
        name: Download MoltenVK for macOS
        inputFiles:
          - ${SRCROOT}/external/MoltenVK/MoltenVK/dynamic/dylib/macOS/libMoltenVK.dylib
        outputFiles:
          - ${BUILT_PRODUCTS_DIR}/libMoltenVK.dylib
  Runtime:
    type: tool
    platform: macOS
    sources:
    - macos/runtime
    settings:
      base:
        CODE_SIGN_ENTITLEMENTS: macos/runtime/runtime.entitlements
        PRODUCT_BUNDLE_IDENTIFIER: io.github.webrogue-runtime.WebrogueLauncher.Runtime
        PRODUCT_NAME: webrogue_runtime
        OTHER_LDFLAGS: "-lwebrogue_macos"
        LIBRARY_SEARCH_PATHS: "$(BUILD_DIR)/rust_artifacts/runtime/$(CONFIGURATION)/$(PLATFORM_NAME)"
        HEADER_SEARCH_PATHS: 
        - "$(SRCROOT)/external/SDL3/include"
        - "$(SRCROOT)/external/SDL3/include/SDL3"
        ENABLE_HARDENED_RUNTIME: true
    dependencies:
    - target: Cargo_macos_runtime
    - target: SDL/SDL3
    - target: GFXStream_macOS
    - sdk: Quartz.framework
    - sdk: Metal.framework
    - sdk: IOKit.framework
    - sdk: GameController.framework
    - sdk: ForceFeedback.framework
    - sdk: CoreVideo.framework
    - sdk: CoreHaptics.framework
    - sdk: CoreFoundation.framework
    - sdk: CoreAudio.framework
    - sdk: Cocoa.framework
    - sdk: Carbon.framework
    - sdk: AudioToolbox.framework
    - sdk: libc++.tbd
    - sdk: libc++abi.tbd
  runnerlib:
    type: library.static
    platform: iOS
    sources:
    - ios/runnerlib 
    settings:
      base:
        SWIFT_INSTALL_OBJC_HEADER: false
        HEADER_SEARCH_PATHS:
        - "$(SRCROOT)/external/SDL3/include"
        - "$(SRCROOT)/external/SDL3/include/SDL3"
        PRODUCT_NAME: runnerlib
        SWIFT_OBJC_BRIDGING_HEADER: "$(SRCROOT)/ios/runnerlib/Bridging-Header.h"
  _SDL: # Needed only to build SDL for aot template
    type: library.static
    platform: iOS
    dependencies:
    - target: SDL/SDL3
  Launcher_iOS:
    type: application
    platform: iOS
    sources:
    - ios/launcher
    - common
    settings:
      base:
        INFOPLIST_FILE: ios/launcher/Info.plist
        CODE_SIGN_ENTITLEMENTS: ios/launcher/ios.entitlements
        PRODUCT_BUNDLE_IDENTIFIER: io.github.webrogue-runtime.WebrogueLauncher
        PRODUCT_NAME: Webrogue Runtime
        OTHER_LDFLAGS: "-lwebrogue_ios"
        LIBRARY_SEARCH_PATHS: "$(BUILD_DIR)/rust_artifacts/ios_launcher/$(CONFIGURATION)/$(PLATFORM_NAME)"
        INFOPLIST_KEY_LSApplicationCategoryType: public.app-category.utilities
        INFOPLIST_KEY_UISupportedInterfaceOrientations: "UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight UIInterfaceOrientationPortrait"
        INFOPLIST_KEY_UISupportedInterfaceOrientations_iPad: "UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown"
        ENABLE_PREVIEWS: true
        INFOPLIST_KEY_UILaunchScreen_Generation: true
        INFOPLIST_KEY_UILaunchStoryboardName: LaunchScreen.storyboard
    dependencies:
    - target: Cargo_iOS_launcher
    - target: GFXStream_iOS
    # SDL deps
    - sdk: UIKit.framework
    - sdk: QuartzCore.framework
    - sdk: Metal.framework
    - sdk: IOKit.framework
    - sdk: GameController.framework
    - sdk: CoreVideo.framework
    - sdk: CoreMotion.framework
    - sdk: CoreHaptics.framework
    - sdk: CoreGraphics.framework
    - sdk: CoreFoundation.framework
    - sdk: CoreBluetooth.framework
    - sdk: CoreAudio.framework
    - sdk: AVFoundation.framework
    - sdk: AudioToolbox.framework

    # Wry deps
    - sdk: WebKit.framework
    # MoltenVK
    - framework: external/MoltenVK/MoltenVK/static/MoltenVK.xcframework
  Runner_iOS:
    type: application
    platform: iOS
    sources:
    - path: ios/runner
      excludes:
      - "aot.*.*.o"
    settings:
      base:
        INFOPLIST_FILE: ios/runner/Info.plist
        CODE_SIGN_ENTITLEMENTS: ios/runner/ios.entitlements
        PRODUCT_BUNDLE_IDENTIFIER: io.github.webrogue-runtime.WebrogueRunner
        PRODUCT_NAME: Webrogue Runner
        OTHER_LDFLAGS:
        - "-lwebrogue_ios"
        - "$(BUILD_DIR)/rust_artifacts/ios_runner/$(CONFIGURATION)/$(PLATFORM_NAME)/aot_lipo.o"
        LIBRARY_SEARCH_PATHS: "$(BUILD_DIR)/rust_artifacts/ios_runner/$(CONFIGURATION)/$(PLATFORM_NAME)"
        SWIFT_OBJC_BRIDGING_HEADER: "$(SRCROOT)/ios/runner/Bridging-Header.h"
        INFOPLIST_KEY_LSApplicationCategoryType: public.app-category.utilities
        INFOPLIST_KEY_UISupportedInterfaceOrientations: "UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight UIInterfaceOrientationPortrait"
        INFOPLIST_KEY_UISupportedInterfaceOrientations_iPad: "UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown"
        ENABLE_PREVIEWS: true
        INFOPLIST_KEY_UILaunchScreen_Generation: true
        INFOPLIST_KEY_UILaunchStoryboardName: LaunchScreen.storyboard
    dependencies:
    - target: Cargo_iOS_runner
    - target: SDL/SDL3
    - target: runnerlib
    - target: GFXStream_iOS
    - sdk: UIKit.framework
    - sdk: QuartzCore.framework
    - sdk: Metal.framework
    - sdk: IOKit.framework
    - sdk: GameController.framework
    - sdk: CoreVideo.framework
    - sdk: CoreMotion.framework
    - sdk: CoreHaptics.framework
    - sdk: CoreGraphics.framework
    - sdk: CoreFoundation.framework
    - sdk: CoreBluetooth.framework
    - sdk: CoreAudio.framework
    - sdk: AVFoundation.framework
    - sdk: AudioToolbox.framework
    - framework: external/MoltenVK/MoltenVK/static/MoltenVK.xcframework
    preBuildScripts:
      - script: "sh ${SRCROOT}/scripts/lipo_object_combiner.sh ${SRCROOT}/ios/runner ${BUILD_DIR}/rust_artifacts/ios_runner/${CONFIGURATION}/${PLATFORM_NAME}/aot_lipo.o"
        name: Combine object to lipo
        inputFiles:
          - ${SRCROOT}/ios/runner/aot.x86_64.iphonesimulator.o
          - ${SRCROOT}/ios/runner/aot.arm64.iphonesimulator.o
          - ${SRCROOT}/ios/runner/aot.arm64.iphoneos.o 
          - ${SRCROOT}/scripts/lipo_object_combiner.sh
        outputFiles:
          - ${BUILD_DIR}/rust_artifacts/ios_runner/${CONFIGURATION}/${PLATFORM_NAME}/aot_lipo.o
          - ${BUILD_DIR}/rust_artifacts/ios_runner/${CONFIGURATION}/${PLATFORM_NAME}/aot_lipo.o.lipo
  Cargo_iOS_launcher:
    platform: iOS
    legacy:
      toolPath: /bin/sh
      arguments: ios/rust/cargo_lipo_builder.sh launcher
      workingDirectory: "$(SRCROOT)/"
      passSettings: true
  Cargo_iOS_runner:
    platform: iOS
    legacy:
      toolPath: /bin/sh
      arguments: ios/rust/cargo_lipo_builder.sh runner
      workingDirectory: "$(SRCROOT)/"
      passSettings: true
  Cargo_macos_runtime:
    platform: macOS
    legacy:
      toolPath: /bin/sh
      arguments: macos/rust/cargo_lipo_builder.sh runtime
      workingDirectory: "$(SRCROOT)/"
      passSettings: true
  Cargo_macos_runner:
    platform: macOS
    legacy:
      toolPath: /bin/sh
      arguments: macos/rust/cargo_lipo_builder.sh runner
      workingDirectory: "$(SRCROOT)/"
      passSettings: true
  Runner:
    type: application
    platform: macOS
    sources:
    - path: macos/runner
      excludes:
      - "aot.*.*.o"
    settings:
      base:
        CODE_SIGN_ENTITLEMENTS: macos/runner/runner.entitlements
        INFOPLIST_FILE: macos/runner/Info.plist
        PRODUCT_BUNDLE_IDENTIFIER: io.github.webrogue-runtime.WebrogueLauncher.Runner
        PRODUCT_NAME: webrogue_runner
        OTHER_LDFLAGS:
        - "-lwebrogue_macos"
        - "$(BUILD_DIR)/rust_artifacts/runner/$(CONFIGURATION)/$(PLATFORM_NAME)/aot_lipo.o"
        LIBRARY_SEARCH_PATHS: "$(BUILD_DIR)/rust_artifacts/runner/$(CONFIGURATION)/$(PLATFORM_NAME)"
        HEADER_SEARCH_PATHS:
        - "$(SRCROOT)/external/SDL3/include"
        - "$(SRCROOT)/external/SDL3/include/SDL3"
        ENABLE_HARDENED_RUNTIME: true
    dependencies:
    - target: Cargo_macos_runner
    - target: SDL/SDL3
    - target: GFXStream_macOS
    - sdk: Quartz.framework
    - sdk: Metal.framework
    - sdk: IOKit.framework
    - sdk: GameController.framework
    - sdk: ForceFeedback.framework
    - sdk: CoreVideo.framework
    - sdk: CoreHaptics.framework
    - sdk: CoreFoundation.framework
    - sdk: CoreAudio.framework
    - sdk: Cocoa.framework
    - sdk: Carbon.framework
    - sdk: AudioToolbox.framework
    - sdk: libc++.tbd
    - sdk: libc++abi.tbd
    - bundle: libMoltenVK.dylib
      embed: true
      codeSign: true
    preBuildScripts:
      - script: "sh ${SRCROOT}/scripts/lipo_object_combiner.sh ${SRCROOT}/macos/runner ${BUILD_DIR}/rust_artifacts/runner/${CONFIGURATION}/${PLATFORM_NAME}/aot_lipo.o"
        name: Combine object to lipo
        inputFiles:
          - ${SRCROOT}/macos/runner/aot.x86_64.macosx.o
          - ${SRCROOT}/macos/runner/aot.arm64.macosx.o
          - ${SRCROOT}/scripts/lipo_object_combiner.sh
        outputFiles:
          - ${BUILD_DIR}/rust_artifacts/runner/${CONFIGURATION}/${PLATFORM_NAME}/aot_lipo.o
          - ${BUILD_DIR}/rust_artifacts/runner/${CONFIGURATION}/${PLATFORM_NAME}/aot_lipo.o.lipo
      - script: "cp \"${SRCROOT}/external/MoltenVK/MoltenVK/dynamic/dylib/macOS/libMoltenVK.dylib\" \"${BUILT_PRODUCTS_DIR}/libMoltenVK.dylib\""
        name: Download MoltenVK for macOS
        inputFiles:
          - ${SRCROOT}/external/MoltenVK/MoltenVK/dynamic/dylib/macOS/libMoltenVK.dylib
        outputFiles:
          - ${BUILT_PRODUCTS_DIR}/libMoltenVK.dylib
schemes:
  MacOS_Launcher_Debug:
    build:
      targets:
        Launcher: Debug
    run:
      config: Debug
  MacOS_Launcher_Release:
    build:
      targets:
        Launcher: Release
    run:
      config: Release
  MacOS_Launcher_ReleaseLocal:
    build:
      targets:
        Launcher: ReleaseLocal
        SDL/SDL3: Release
    run:
      config: ReleaseLocal
  MacOS_Runner_Debug:
    build:
      targets:
        Runner: Debug
    run:
      config: Debug
  MacOS_Runner_Release:
    build:
      targets:
        Runner: Release
    run:
      config: Release
  MacOS_Runner_ReleaseLocal:
    build:
      targets:
        Runner: ReleaseLocal
    run:
      config: ReleaseLocal
  iOS_Launcher_Debug:
    build:
      targets:
        Launcher_iOS: Debug
    run:
      config: Debug
  iOS_Launcher_Release:
    build:
      targets:
        Launcher_iOS: Release
    run:
      config: Release
  iOS_Launcher_ReleaseLocal:
    build:
      targets:
        Launcher_iOS: ReleaseLocal
    run:
      config: ReleaseLocal
  iOS_Runner_Debug:
    build:
      targets:
        Runner_iOS: Debug
    run:
      config: Debug
  iOS_Runner_Release:
    build:
      targets:
        Runner_iOS: Release
    run:
      config: Release
  iOS_Runner_ReleaseLocal:
    build:
      targets:
        Runner_iOS: ReleaseLocal
    run:
      config: ReleaseLocal
